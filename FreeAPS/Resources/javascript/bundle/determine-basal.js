var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(e/18,1):Math.round(e)}var i="",s="",l="",d="",m="",u="",c="",g="",b="";function f(e,r){var a=[2,7,12,16,20,50,60,80,90,100,110,150,180,200],t=[0,0,.4,.7,.7,-.5,-.5,-.3,-.2,0,0,.5,.7,.7],o=a.length-1,n=a[0],i=t[0],s=a[o],l=t[o],d=1,m=1,u=1,c=n;if(n>e)d=(m=i)+((l=t[1])-m)/((s=a[1])-(u=n))*(e-u);else if(s<e)d=(m=i=t[o-1])+(l-m)/(s-(u=n=a[o-1]))*(e-u);else for(var g=0;g<=o;g++){if(i=t[g],(n=a[g])==e){d=i;break}if(n>e){d=m+(i-m)/(n-(u=c))*(e-u);break}m=i,c=n}return d*=e>100?r.higher_ISFrange_weight:e>40?r.lower_ISFrange_weight:r.delta_ISFrange_weight}function p(e,r,a){if(void 0===e.smb_delivery_ratio_bg_range||0===e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio set to fixed value "+e.smb_delivery_ratio),e.smb_delivery_ratio;var t=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r<=a)return console.error("SMB delivery ratio limited by minimum value "+t),t;var n=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r>=a+e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio limited by maximum value "+n),n;var i=t+(n-t)*(r-a)/e.smb_delivery_ratio_bg_range;return console.error("SMB delivery ratio set to interpolated value "+o(i,2)),i}e.exports=function(e,r,a,h,v,_,B,M,x,S){var y={},C=new Date;if(S&&(C=S),void 0===h||void 0===h.current_basal)return y.error="Error: could not get current basal rate",y;var I=t(h.current_basal,h),F=I,G=new Date;S&&(G=S);var w,O=new Date(e.date),R=o((G-O)/60/1e3,1),A=e.glucose,T=e.noise;w=e.delta>-.5?"+"+o(e.delta,0):o(e.delta,0);var D=Math.min(e.delta,e.short_avgdelta),U=Math.min(e.short_avgdelta,e.long_avgdelta),j=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(A<=10||38===A||T>=3)&&(y.reason="CGM is calibrating, in ??? state, or noise is high");if(A>60&&0==e.delta&&e.short_avgdelta>-1&&e.short_avgdelta<1&&e.long_avgdelta>-1&&e.long_avgdelta<1&&("fakecgm"==e.device?(console.error("CGM data is unchanged ("+n(A,h)+"+"+n(e.delta,h)+") for 5m w/ "+n(e.short_avgdelta,h)+" mg/dL ~15m change & "+n(e.long_avgdelta,2)+" mg/dL ~45m change"),console.error("Simulator mode detected ("+e.device+"): continuing anyway")):!0),R>12||R<-5?y.reason="If current system time "+G+" is correct, then BG data is too old. The last BG data was read "+R+"m ago at "+O:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?y.reason="CGM was just calibrated":y.reason="CGM data is unchanged ("+n(A,h)+"+"+n(e.delta,h)+") for 5m w/ "+n(e.short_avgdelta,h)+" mg/dL ~15m change & "+n(e.long_avgdelta,h)+" mg/dL ~45m change"),A<=10||38===A||T>=3||R>12||R<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>=F?(y.reason+=". Canceling high temp basal of "+r.rate,y.deliverAt=C,y.temp="absolute",y.duration=0,y.rate=0,y):0===r.rate&&r.duration>30?(y.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",y.deliverAt=C,y.temp="absolute",y.duration=30,y.rate=0,y):(y.reason+=". Temp "+r.rate+" <= current basal "+F+"U/hr; doing nothing. ",y);var P,q,E,W=h.max_iob;if(void 0!==h.min_bg&&(q=h.min_bg),void 0!==h.max_bg&&(E=h.max_bg),void 0===h.min_bg||void 0===h.max_bg)return y.error="Error: could not determine target_bg. ",y;P=(h.min_bg+h.max_bg)/2;var k=h.exercise_mode||h.high_temptarget_raises_sensitivity,z=100,L=160;if(h.half_basal_exercise_target&&(L=h.half_basal_exercise_target),k&&h.temptargetSet&&P>z||h.low_temptarget_lowers_sensitivity&&h.temptargetSet&&P<z){var N=L-z;N+P-z>0?(sensitivityRatio=N/(N+P-z),sensitivityRatio=Math.min(sensitivityRatio,h.autosens_max),sensitivityRatio=o(sensitivityRatio,2)):sensitivityRatio=h.autosens_max,process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+P+"; ")}else void 0!==v&&v&&(sensitivityRatio=v.ratio,process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(F=h.current_basal*sensitivityRatio,(F=t(F,h))!==I?process.stderr.write("Adjusting basal from "+I+" to "+F+"; "):process.stderr.write("Basal unchanged: "+F+"; ")),h.temptargetSet);else if(void 0!==v&&v&&(h.sensitivity_raises_target&&v.ratio<1||h.resistance_lowers_target&&v.ratio>1)){q=o((q-60)/v.ratio)+60,E=o((E-60)/v.ratio)+60;var Z=o((P-60)/v.ratio)+60;P===(Z=Math.max(80,Z))?process.stderr.write("target_bg unchanged: "+Z+"; "):process.stderr.write("target_bg from "+P+" to "+Z+"; "),P=Z}var $=200,H=200,J=200;if(e.noise>=2){var K=Math.max(1.1,h.noisyCGMTargetMultiplier);Math.min(250,h.maxRaw);$=o(Math.min(200,q*K)),H=o(Math.min(200,P*K)),J=o(Math.min(200,E*K)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+P+" to "+H+"; "),q=$,P=H,E=J}var Q=q-.5*(q-40),V=o(h.sens,1),X=h.sens;if(void 0!==v&&v&&((X=o(X=h.sens/sensitivityRatio,1))!==V?process.stderr.write("ISF from "+n(V,h)+" to "+n(X,h)):process.stderr.write("ISF unchanged: "+n(X,h)),i+="Autosens, Ratio: "+sensitivityRatio+", ISF: "+n(V,h)+"→"+n(X,h)),console.error("CR:"+h.carb_ratio),X=function(e,r,a,t,h,v,_,B){if(!a.use_autoisf)return console.error("autoISF disabled in Preferences"),e;var M=t.dura_p,x=t.delta_pl,S=t.delta_pn,y=t.r_squ,C=t.bg_acceleration,I=t.parabola_fit_a0,F=t.parabola_fit_a1,G=t.parabola_fit_a2,w=t.autoISF_duration,O=t.autoISF_average,R=a.autoisf_max,A=!1,T=1,D=1,U=1,j=r+10-O;if(!(h.mealCOB>0)||a.enableautoisf_with_COB){var P=t.pp_debug;if(u+="BG-accel: "+o(C,3)+", PF-minutes: "+M+", PF-corr: "+o(y,3)+", PF-nextDelta: "+n(S,a)+", PF-lastDelta: "+n(x,a)+", regular Delta: "+n(t.delta,a),console.error(P+u+" , Weights Accel/Brake: "+a.bgAccel_ISF_weight+" / "+a.bgBrake_ISF_weight),a.enable_BG_acceleration){var q=C;if(0!=t.parabola_fit_a2){var E=-F/2/G*5,W=o(I-E*E/25*G,1);(E=o(E,1))<0&&q<0?(b="saw max of "+n(W,a)+", about "+-E+" min ago",console.error("Parabolic fit "+b)):E<0&&q>0?(b="saw min of "+n(W,a)+", about "+-E+" min ago",console.error("Parabolic fit "+b)):E>0&&q<0?(b="predicts max of "+n(W,a)+", in about "+E+"min",console.error("Parabolic fit "+b)):E>0&&q>0&&(b="predicts min of "+n(W,a)+", in about "+E+" min",console.error("Parabolic fit "+b))}var k=y;if(k<.9)b="acce_ISF by-passed, as correlation, "+o(k,3)+", is too low",console.error("Parabolic fit "+b),c+=", Parabolic Fit, "+b;else{c+=", Parabolic Fit, "+b+", regΔ: "+n(t.delta,a)+", lastΔ: "+n(x,a)+", nextΔ: "+n(S,a)+", Corr "+o(y,3)+", BG-Accel: "+o(q,2);var z=10*(k-.9),L=1;t.glucose<a.target_bg&&q>1&&(L=.5),U=1+q*L*(q<0?a.bgBrake_ISF_weight:a.bgAccel_ISF_weight)*z,console.error("Original result for acce_ISF: "+o(U,2)),1!=U&&(A=!0,c+=", accel. Ratio: "+o(U,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");var N=p(a,t.glucose,r);i+=", SMB Delivery Ratio:, "+o(N,2)+", autoISF";var Z=1+f(100-j,a);if(console.error("bg_ISF adaptation is "+o(Z,2)),Z<1)return U>1&&(g="bg_ISF adaptation lifted to "+o(Z*=U,2)+", as BG accelerates already",console.error(g)),Z<a.autoisf_min?(g="bg_ISF adaptation "+o(Z,2)+" limited by autoisf_min "+a.autoisf_min,console.error(g),s=", ltd. bg-ISF Ratio: "+a.autoisf_min,Z=a.autoisf_min):Z>R&&(g="bg_ISF adaptation "+o(Z,2)+", limited by autoisf_max "+R,console.error(g),s=", ltd. bg-ISF Ratio: "+R,Z=R),earlysens=Math.min(720,o(a.sens/Math.max(a.autoisf_min,Z),1)),console.error("early Return autoISF:  "+n(earlysens,a)),i+=", bg-ISF Ratio: "+o(Z,2)+s+", ISF: "+n(earlysens,a),earlysens;Z>1&&(A=!0,i+=", bg-ISF Ratio: "+o(Z,2));var $=t.delta;j>0?console.error("delta_ISF adaptation by-passed as average glucose < "+n(r+10,a)):t.short_avgdelta<0?console.error("delta_ISF adaptation by-passed as no rise or too short lived"):a.enableppisf_always||a.postmeal_ISF_duration>=(v-h.lastCarbTime)/1e3/3600?(T=1+Math.max(0,$*a.postmeal_ISF_weight),console.error("pp_ISF adaptation is "+o(T,2)),d=", pp-ISF Ratio: "+o(T,2),1!=T&&(A=!0)):(D=f($,a),j>-20&&(D*=.5),D=1+D,console.error("delta_ISF adaptation is",o(D,2)),m=", Δ-ISF Ratio: "+o(D,2),1!=D&&(A=!0));var H=1,J=a.autoisf_hourlychange;h.mealCOB>0&&!a.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(h.mealCOB,1)):w<10?console.error("dura_ISF by-passed; BG is only "+w+"m at level "+O):O<=r?console.error("dura_ISF by-passed; avg. glucose "+O+" below target "+n(r,a)):(A=!0,l=", dura-ISF Ratio: "+o(H+=w/60*(J/r)*(O-r),2),console.error("dura_ISF  adaptation is "+o(H,2)+" because ISF "+e+" did not do it for "+o(w,1)+"m"));var K=1;return A?(K=Math.max(H,Z,D,U,T),console.error("autoISF adaption ratios:"),console.error("  dura "+o(H,2)),console.error("  bg "+o(Z,2)),console.error("  delta "+o(D,2)),console.error("  pp "+o(T,2)),console.error("  accel "+o(U,2)),U<1&&(console.error("strongest ISF factor "+o(K,2)+" weakened to "+o(K*U,2)+" as bg decelerates already"),K*=U),K<a.autoisf_min?(console.error("final ISF factor "+o(K,2)+" limited by autoisf_min "+a.autoisf_min),K=a.autoisf_min):K>R&&(console.error("final ISF factor "+o(K,2)+" limited by autoisf_max "+R),K=R),K>1&&(e=o(a.sens/Math.max(K,B),1)),K<=1&&(e=o(a.sens/Math.min(K,B),1))):K=B,i+=", Duration: "+w+", Avg: "+n(O,a)+s+d+m+l+", Ratio: "+o(K,2)+", ISF: "+n(e,a)+c,console.error("Inside autoISF: Ratio "+o(K,2)+" resulting in "+n(e,a)),e}console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(h.mealCOB,1))}(X,P,h,e,_,S,0,sensitivityRatio),void 0===a)return y.error="Error: iob_data undefined. ",y;var Y,ee=a;if(a.length,a.length>1&&(a=ee[0]),void 0===a.activity||void 0===a.iob)return y.error="Error: iob_data missing some property. ",y;var re=((Y=void 0!==a.lastTemp?o((new Date(G).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+Y+"m, tempModulus:"+re+"m"),y.temp="absolute",y.deliverAt=C,M&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&Y>10&&r.duration)return y.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",B.setTempBasal(0,0,h,y,r);if(r&&a.lastTemp&&r.duration>0){var ae=Y-a.lastTemp.duration;if(ae>5&&Y>10)return y.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+ae+"m ago; canceling temp",B.setTempBasal(0,0,h,y,r)}var te=o(-a.activity*X*5,2),oe=o(6*(D-te));oe<0&&(oe=o(6*(U-te)))<0&&(oe=o(6*(e.long_avgdelta-te)));var ne=A,ie=(ne=a.iob>0?o(A-a.iob*X):o(A-a.iob*Math.min(X,h.sens)))+oe;if(void 0===ie||isNaN(ie))return y.error="Error: could not calculate eventualBG. Sensitivity: "+X+" Deviation: "+oe,y;var se=function(e,r,a){return o(a+(e-r)/24,1)}(P,ie,te);y={temp:"absolute",bg:A,tick:w,eventualBG:ie,insulinReq:0,reservoir:x,deliverAt:C,sensitivityRatio};var le=[],de=[],me=[],ue=[];le.push(A),de.push(A),ue.push(A),me.push(A);var ce=function(e,r,a,t){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&t>100?(console.error("SMB disabled due to high temptarget of",t),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&t<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(t,e)),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(h,M,_,P),ge=h.enableUAM,be=0,fe=0;be=o(D-te,1);var pe=o(D-te,1);csf=X/h.carb_ratio,console.error("profile.sens:"+n(h.sens,h)+", sens:"+n(X,h)+", CSF:"+o(csf,1));var he=o(30*csf*5/60,1);be>he&&(console.error("Limiting carb impact from "+be+" to "+he+"mg/dL/5m (30g/h)"),be=he);var ve=3;sensitivityRatio&&(ve/=sensitivityRatio);var _e=ve;if(_.carbs){ve=Math.max(ve,_.mealCOB/20);var Be=o((new Date(G).getTime()-_.lastCarbTime)/6e4),Me=(_.carbs-_.mealCOB)/_.carbs;_e=o(_e=ve+1.5*Be/60,1),console.error("Last carbs "+Be+" minutes ago; remainingCATime:"+_e+"hours; "+o(100*Me)+"% carbs absorbed")}var xe=Math.max(0,be/5*60*_e/2)/csf,Se=90,ye=1;h.remainingCarbsCap&&(Se=Math.min(90,h.remainingCarbsCap)),h.remainingCarbsFraction&&(ye=Math.min(1,h.remainingCarbsFraction));var Ce=1-ye,Ie=Math.max(0,_.mealCOB-xe-_.carbs*Ce),Fe=(Ie=Math.min(Se,Ie))*csf*5/60/(_e/2),Ge=o(_.slopeFromMaxDeviation,2),we=o(_.slopeFromMinDeviation,2),Oe=Math.min(Ge,-we/3),Re=0;0===be?fe=0:!0===h.floating_carbs?(fe=Math.min(60*_e/5/2,Math.max(0,_.carbs*csf/be)),Re=Math.min(60*_e/5/2,Math.max(0,_.mealCOB*csf/be)),_.carbs>0&&(i+=", Floating Carbs:, CID: "+o(fe,1)+", MealCarbs: "+o(_.carbs,1)+", Not Floating:, CID: "+o(Re,1)+", MealCOB: "+o(_.mealCOB,1),console.error("Floating Carbs CID: "+o(fe,1)+" / MealCarbs: "+o(_.carbs,1)+" vs. Not Floating:"+o(Re,1)+" / MealCOB:"+o(_.mealCOB,1)))):fe=Math.min(60*_e/5/2,Math.max(0,_.mealCOB*csf/be)),console.error("Carb Impact:"+be+"mg/dL per 5m; CI Duration:"+o(5*fe/60*2,1)+"hours; remaining CI ("+_e/2+"h peak):",o(Fe,1)+"mg/dL per 5m");var Ae,Te,De,Ue,je,Pe=999,qe=999,Ee=999,We=A,ke=999,ze=999,Le=999,Ne=999,Ze=ie,$e=A,He=A,Je=0,Ke=[],Qe=[];try{ee.forEach((function(e){var r=o(-e.activity*X*5,2),a=o(-e.iobWithZeroTemp.activity*X*5,2),t=be*(1-Math.min(1,de.length/12));Ze=de[de.length-1]+r+t;var n=ue[ue.length-1]+a,i=Math.max(0,Math.max(0,be)*(1-le.length/Math.max(2*fe,1))),s=Math.min(le.length,12*_e-le.length),l=Math.max(0,s/(_e/2*12)*Fe);i+l,Ke.push(o(l,0)),Qe.push(o(i,0)),COBpredBG=le[le.length-1]+r+Math.min(0,t)+i+l;var d=Math.max(0,pe+me.length*Oe),m=Math.max(0,pe*(1-me.length/Math.max(36,1))),u=Math.min(d,m);u>0&&(Je=o(5*(me.length+1)/60,1)),UAMpredBG=me[me.length-1]+r+Math.min(0,t)+u,de.length<48&&de.push(Ze),le.length<48&&le.push(COBpredBG),me.length<48&&me.push(UAMpredBG),ue.length<48&&ue.push(n),COBpredBG<ke&&(ke=o(COBpredBG)),UAMpredBG<ze&&(ze=o(UAMpredBG)),Ze<Le&&(Le=o(Ze)),n<Ne&&(Ne=o(n));de.length>18&&Ze<Pe&&(Pe=o(Ze)),Ze>$e&&($e=Ze),(fe||Fe>0)&&le.length>18&&COBpredBG<qe&&(qe=o(COBpredBG)),(fe||Fe>0)&&COBpredBG>$e&&(He=COBpredBG),ge&&me.length>12&&UAMpredBG<Ee&&(Ee=o(UAMpredBG)),ge&&UAMpredBG>$e&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}_.mealCOB&&(console.error("predCIs (mg/dL/5m):"+Qe.join(" ")),console.error("remainingCIs:      "+Ke.join(" "))),y.predBGs={},de.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var Ve=de.length-1;Ve>12&&de[Ve-1]===de[Ve];Ve--)de.pop();for(y.predBGs.IOB=de,De=o(de[de.length-1]),ue.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ve=ue.length-1;Ve>6&&!(ue[Ve-1]>=ue[Ve]||ue[Ve]<=P);Ve--)ue.pop();if(y.predBGs.ZT=ue,o(ue[ue.length-1]),_.mealCOB>0&&(be>0||Fe>0)){for(le.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ve=le.length-1;Ve>12&&le[Ve-1]===le[Ve];Ve--)le.pop();y.predBGs.COB=le,Ue=o(le[le.length-1]),ie=Math.max(ie,o(le[le.length-1]))}if(be>0||Fe>0){if(ge){for(me.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ve=me.length-1;Ve>12&&me[Ve-1]===me[Ve];Ve--)me.pop();y.predBGs.UAM=me,je=o(me[me.length-1]),me[me.length-1]&&(ie=Math.max(ie,o(me[me.length-1])))}y.eventualBG=ie}console.error("UAM Impact:"+pe+"mg/dL per 5m; UAM Duration:"+Je+"hours"),Pe=Math.max(39,Pe),qe=Math.max(39,qe),Ee=Math.max(39,Ee),Ae=o(Pe);var Xe=_.mealCOB/_.carbs;Te=o(Ee<999&&qe<999?(1-Xe)*UAMpredBG+Xe*COBpredBG:qe<999?(Ze+COBpredBG)/2:Ee<999?(Ze+UAMpredBG)/2:Ze),Ne>Te&&(Te=Ne),We=o(We=fe||Fe>0?ge?Xe*ke+(1-Xe)*ze:ke:ge?ze:Le);var Ye=Ee;if(Ne<Q)Ye=(Ee+Ne)/2;else if(Ne<P){var er=(Ne-Q)/(P-Q);Ye=(Ee+(Ee*er+Ne*(1-er)))/2}else Ne>Ee&&(Ye=(Ee+Ne)/2);if(Ye=o(Ye),_.carbs)if(!ge&&qe<999)Ae=o(Math.max(Pe,qe));else if(qe<999){var rr=Xe*qe+(1-Xe)*Ye;Ae=o(Math.max(Pe,qe,rr))}else Ae=ge?Ye:We;else ge&&(Ae=o(Math.max(Pe,Ye)));Ae=Math.min(Ae,Te),process.stderr.write("minPredBG: "+Ae+" minIOBPredBG: "+Pe+" minZTGuardBG: "+Ne),qe<999&&process.stderr.write(" minCOBPredBG: "+qe),Ee<999&&process.stderr.write(" minUAMPredBG: "+Ee),console.error(" avgPredBG:"+Te+" COB/Carbs:"+_.mealCOB+"/"+_.carbs),He>A&&(Ae=Math.min(Ae,He)),y.COB=_.mealCOB,y.IOB=a.iob,y.BGI=n(te,h),y.deviation=n(oe,h),y.ISF=n(X,h),y.CR=o(h.carb_ratio,2),y.target_bg=n(P,h),y.reason=i+", Standard, COB: "+y.COB+", Dev: "+y.deviation+", BGI: "+y.BGI+", CR: "+y.CR+", Target: "+y.target_bg+", minPredBG "+n(Ae,h)+", minGuardBG "+n(We,h)+", IOBpredBG "+n(De,h),Ue>0&&(y.reason+=", COBpredBG "+n(Ue,h)),je>0&&(y.reason+=", UAMpredBG "+n(je,h)),y.reason+="; ";var ar=ne;ar<40&&(ar=Math.min(We,ar));var tr,or=Q-ar,nr=240,ir=240;if(_.mealCOB>0&&(be>0||Fe>0)){for(Ve=0;Ve<le.length;Ve++)if(le[Ve]<q){nr=5*Ve;break}for(Ve=0;Ve<le.length;Ve++)if(le[Ve]<Q){ir=5*Ve;break}}else{for(Ve=0;Ve<de.length;Ve++)if(de[Ve]<q){nr=5*Ve;break}for(Ve=0;Ve<de.length;Ve++)if(de[Ve]<Q){ir=5*Ve;break}}ce&&We<Q&&(console.error("minGuardBG "+n(We,h)+" projected below "+n(Q,h)+" - disabling SMB"),ce=!1),void 0===h.maxDelta_bg_threshold&&(tr=.2),void 0!==h.maxDelta_bg_threshold&&(tr=Math.min(h.maxDelta_bg_threshold,.4)),j>tr*A&&(console.error("maxDelta "+n(j,h)+" > "+100*tr+"% of BG "+n(A,h)+" - disabling SMB"),y.reason+="maxDelta "+n(j,h)+" > "+100*tr+"% of BG "+n(A,h)+" - SMB disabled!, ",ce=!1),console.error("BG projected to remain above "+n(q,h)+" for "+nr+"minutes"),(ir<240||nr<60)&&console.error("BG projected to remain above "+n(Q,h)+" for "+ir+"minutes");var sr=ir,lr=h.current_basal*X*sr/60,dr=Math.max(0,_.mealCOB-.25*_.carbs),mr=(or-lr)/csf-dr;lr=o(lr),mr=o(mr),console.error("naive_eventualBG:"+ne+" bgUndershoot:"+or+" zeroTempDuration:"+sr+" zeroTempEffect:"+lr+" carbsReq:"+mr),mr>=h.carbsReqThreshold&&ir<=45&&(y.carbsReq=mr,y.reason+=mr+" add'l carbs req w/in "+ir+"m; ");var ur=0;if(A<Q&&a.iob<20*-h.current_basal/60&&D>0&&D>se)y.reason+="IOB "+a.iob+" < "+o(20*-h.current_basal/60,2),y.reason+=" and minDelta "+n(D,h)+" > expectedDelta "+n(se,h)+"; ";else if(A<Q||We<Q)return y.reason+="minGuardBG "+n(We,h)+"<"+n(Q,h),ur=o(60*((or=P-We)/X)/h.current_basal),ur=30*o(ur/30),ur=Math.min(120,Math.max(30,ur)),B.setTempBasal(0,ur,h,y,r);if(h.skip_neutral_temps&&y.deliverAt.getMinutes()>=55)return y.reason+="; Canceling temp at "+y.deliverAt.getMinutes()+"m past the hour. ",B.setTempBasal(0,0,h,y,r);var cr=0,gr=F;if(ie<q){if(y.reason+="Eventual BG "+n(ie,h)+" < "+n(q,h),D>se&&D>0&&!mr)return ne<40?(y.reason+=", naive_eventualBG < 40. ",B.setTempBasal(0,30,h,y,r)):(e.delta>D?y.reason+=", but Delta "+n(w,h)+" > expectedDelta "+n(se,h):y.reason+=", but Min. Delta "+D.toFixed(2)+" > Exp. Delta "+n(se,h),r.duration>15&&t(F,h)===t(r.rate,h)?(y.reason+=", temp "+r.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,h,y,r)));cr=o(cr=2*Math.min(0,(ie-P)/X),2);var br=Math.min(0,(ne-P)/X);if(br=o(br,2),D<0&&D>se)cr=o(cr*(D/se),2);if(gr=t(gr=F+2*cr,h),r.duration*(r.rate-F)/60<Math.min(cr,br)-.3*F)return y.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",B.setTempBasal(gr,30,h,y,r);if(void 0!==r.rate&&r.duration>5&&gr>=.8*r.rate)return y.reason+=", temp "+r.rate+" ~< req "+gr+"U/hr. ",y;if(gr<=0){if((ur=o(60*((or=P-ne)/X)/h.current_basal))<0?ur=0:(ur=30*o(ur/30),ur=Math.min(120,Math.max(0,ur))),ur>0)return y.reason+=", setting "+ur+"m zero temp. ",B.setTempBasal(gr,ur,h,y,r)}else y.reason+=", setting "+gr+"U/hr. ";return B.setTempBasal(gr,30,h,y,r)}if(D<se&&(!M||!ce))return e.delta<D?y.reason+="Eventual BG "+n(ie,h)+" > "+n(q,h)+" but Delta "+n(w,h)+" < Exp. Delta "+n(se,h):y.reason+="Eventual BG "+n(ie,h)+" > "+n(q,h)+" but Min. Delta "+D.toFixed(2)+" < Exp. Delta "+n(se,h),r.duration>15&&t(F,h)===t(r.rate,h)?(y.reason+=", temp "+r.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,h,y,r));if(Math.min(ie,Ae)<E&&(!M||!ce))return y.reason+=n(ie,h)+"-"+n(Ae,h)+" in range: no temp required",r.duration>15&&t(F,h)===t(r.rate,h)?(y.reason+=", temp "+r.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,h,y,r));if(ie>=E&&(y.reason+="Eventual BG "+n(ie,h)+" >= "+n(E,h)+", "),a.iob>W)return y.reason+="IOB "+o(a.iob,2)+" > max_iob "+W,r.duration>15&&t(F,h)===t(r.rate,h)?(y.reason+=", temp "+r.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,h,y,r));(cr=o((Math.min(Ae,ie)-P)/X,2))>W-a.iob&&(y.reason+="max_iob "+W+", ",cr=W-a.iob),gr=t(gr=F+2*cr,h),cr=o(cr,3),y.insulinReq=cr;var fr=o((new Date(G).getTime()-a.lastBolusTime)/6e4,1);if(M&&ce&&A>Q){var pr=o(_.mealCOB/h.carb_ratio,3);if(h.use_autoisf)hr=h.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var hr=1}hr>1&&console.error("SMB max range extended from default by factor "+hr);var vr=0;void 0===h.maxSMBBasalMinutes?(vr=o(hr*h.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>pr&&a.iob>0?(console.error("IOB",a.iob,"> COB",_.mealCOB+"; mealInsulinReq =",pr),h.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",h.maxUAMSMBBasalMinutes,"profile.current_basal:",h.current_basal),vr=o(hr*h.current_basal*h.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),vr=o(30*h.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",h.maxSMBBasalMinutes,"profile.current_basal:",h.current_basal),vr=o(hr*h.current_basal*h.maxSMBBasalMinutes/60,1));var _r=h.bolus_increment,Br=1/_r;if(h.use_autoisf)var Mr=p(h,A,P);else console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),Mr=.5;Mr>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(Mr,2));var xr=Math.min(cr*Mr,vr);xr=Math.floor(xr*Br)/Br,ur=o(60*((P-(ne+Pe)/2)/X)/h.current_basal),cr>0&&xr<_r&&(ur=0);var Sr=0;ur<=0?ur=0:ur>=30?(ur=30*o(ur/30),ur=Math.min(60,Math.max(0,ur))):(Sr=o(F*ur/30,2),ur=30),y.reason+=" insulinReq "+cr,xr>=vr&&(y.reason+="; maxBolus "+vr),ur>0&&(y.reason+="; setting "+ur+"m low temp of "+Sr+"U/h"),y.reason+=". ";var yr=3;h.SMBInterval&&(yr=Math.min(10,Math.max(1,h.SMBInterval)));var Cr=o(yr-fr,0),Ir=o(60*(yr-fr),0)%60;if(console.error("naive_eventualBG",ne+",",ur+"m "+Sr+"U/h temp needed; last bolus",fr+"m ago; maxBolus: "+vr),fr>yr?xr>0&&(y.units=xr,y.reason+="Microbolusing "+xr+"U. "):y.reason+="Waiting "+Cr+"m "+Ir+"s to microbolus again. ",ur>0)return y.rate=Sr,y.duration=ur,y}var Fr=B.getMaxSafeBasal(h);return gr>Fr&&(y.reason+="adj. req. rate: "+gr+" to maxSafeBasal: "+Fr+", ",gr=t(Fr,h)),r.duration*(r.rate-F)/60>=2*cr?(y.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+gr+"U/hr. ",B.setTempBasal(gr,30,h,y,r)):void 0===r.duration||0===r.duration?(y.reason+="no temp, setting "+gr+"U/hr. ",B.setTempBasal(gr,30,h,y,r)):r.duration>5&&t(gr,h)<=t(r.rate,h)?(y.reason+="temp "+r.rate+" >~ req "+gr+"U/hr. ",y):(y.reason+="temp "+r.rate+"<"+gr+"U/hr. ",B.setTempBasal(gr,30,h,y,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,d=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?d(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();