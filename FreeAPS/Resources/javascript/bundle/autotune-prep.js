var freeaps_autotunePrep;(()=>{var e={10:(e,t,a)=>{var r=a(260),i=a(785);e.exports=function(e){var t={treatments:r(e),profile:e.profile,pumpHistory:e.history,glucose:e.glucose,basalprofile:e.profile.basalprofile,pumpbasalprofile:e.pumpprofile.basalprofile,categorize_uam_as_basal:e.categorize_uam_as_basal},a=i(t);if(e.tune_insulin_curve)if("bilinear"===t.profile.curve)console.error("--tune-insulin-curve is set but only valid for exponential curves");else{var n=1e6,o=[],s=[],u=t.profile.dia,l=(t.profile.insulinPeakTime,console.error);console.error=function(){};for(var d=u+2,p=u-2;p<=d;++p){var m=0,c=0,f=0;t.profile.dia=p;for(var g=i(t),v=g.basalGlucoseData,h=0;h<24;++h)for(var b=0;b<v.length;++b){var _;v[b].date?_=new Date(v[b].date):v[b].displayTime?_=new Date(v[b].displayTime.replace("T"," ")):v[b].dateString?_=new Date(v[b].dateString):l("Could not determine last BG time");var T=_.getHours();h===T&&(m+=Math.pow(parseFloat(Math.abs(v[b].deviation)),.5),c+=Math.abs(parseFloat(v[b].deviation)),f+=Math.pow(parseFloat(v[b].deviation),2))}var y=Math.round(1e3*Math.abs(c/v.length))/1e3,D=Math.round(1e3*Math.pow(m/v.length,2))/1e3,M=Math.round(1e3*Math.pow(f/v.length,.5))/1e3;l("insulinEndTime",p,"meanDeviation:",y,"SMRDeviation:",D,"RMSDeviation:",M,"(mg/dL)"),o.push({dia:p,meanDeviation:y,SMRDeviation:D,RMSDeviation:M}),a.diaDeviations=o,(c=Math.round(1e3*c)/1e3)<n&&(n=Math.round(1e3*c)/1e3,p)}n=1e6;t.profile.dia=u,!0==!t.profile.useCustomPeakTime&&"ultra-rapid"===t.profile.curve?t.profile.insulinPeakTime=55:!0==!t.profile.useCustomPeakTime&&(t.profile.insulinPeakTime=75),t.profile.useCustomPeakTime=!0;for(var w=t.profile.insulinPeakTime-10,C=t.profile.insulinPeakTime+10,k=w;k<=C;k+=5){for(m=0,c=0,f=0,t.profile.insulinPeakTime=k,v=(g=i(t)).basalGlucoseData,h=0;h<24;++h)for(b=0;b<v.length;++b)v[b].date?_=new Date(v[b].date):v[b].displayTime?_=new Date(v[b].displayTime.replace("T"," ")):v[b].dateString?_=new Date(v[b].dateString):l("Could not determine last BG time"),h===(T=_.getHours())&&(m+=Math.pow(parseFloat(Math.abs(v[b].deviation)),.5),c+=Math.abs(parseFloat(v[b].deviation)),f+=Math.pow(parseFloat(v[b].deviation),2));console.error(f),l("insulinPeakTime",k,"meanDeviation:",y=Math.round(c/v.length*1e3)/1e3,"SMRDeviation:",D=Math.round(1e3*Math.pow(m/v.length,2))/1e3,"RMSDeviation:",M=Math.round(1e3*Math.pow(f/v.length,.5))/1e3,"(mg/dL)"),s.push({peak:k,meanDeviation:y,SMRDeviation:D,RMSDeviation:M}),a.diaDeviations=o,(c=Math.round(1e3*c)/1e3)<n&&(n=Math.round(1e3*c)/1e3,k)}a.peakDeviations=s,console.error=l}return a}},83:(e,t)=>{"use strict";t.maxDailyBasal=function(e){var t=e.basals.length?e.basals.reduce(((e,t)=>Number(t.rate)>Number(e.rate)?t:e)):null;return 1e3*Number(t.rate)/1e3},t.maxBasalLookup=function(e){return e.settings.maxBasal},t.basalLookup=function(e,t){var a=t;void 0===t&&(a=new Date);var r=e.slice().sort(((e,t)=>e.i-t.i)),i=r[r.length-1].rate;if(0!==i){for(var n=60*a.getHours()+a.getMinutes(),o=0;o<r.length-1;o++)if(n>=r[o].minutes&&n<r[o+1].minutes){i=r[o].rate;break}return Math.round(1e3*i)/1e3}console.error("ERROR: bad basal schedule",e)}},191:(e,t,a)=>{"use strict";var r=a(466),i=a(635),n=a(663),o=a(249);e.exports=function(e,t,a){if(a)s=[];else{a=i(e);var s=i(e,240)}var u={treatments:a,profile:e.profile,calculate:n};e.autosens&&(u.autosens=e.autosens);var l={treatments:s,profile:e.profile,calculate:n},d=[];/(Z|[+-][0-2][0-9]:?[034][05])+/.test(e.clock)||console.error("Warning: clock input "+e.clock+" is unzoned; please pass clock-zoned.json instead");var p,m=r(e.clock),c=new Date(0).getTime(),f={};f.date=new Date(0).getTime(),a.forEach((function(e){e.insulin&&e.started_at?c=Math.max(c,e.started_at):"number"==typeof e.rate&&e.duration&&e.date>f.date&&((f=e).duration=Math.round(100*f.duration)/100)})),p=t?1:240;for(var g=0;g<p;g+=5){var v=new Date(m.getTime()+6e4*g),h=o(u,v),b=o(l,v);d.push(h),d[d.length-1].iobWithZeroTemp=b}return d[0].lastBolusTime=c,d[0].lastTemp=f,d}},249:(e,t)=>{"use strict";e.exports=function(e,t){var a,r=t.getTime(),i=e.calculate,n=e.treatments,o=e.profile,s=o.dia,u=0,l=0,d=0,p=0,m=0,c=0;if(!n)return{};s<3&&(s=3);var f={bilinear:{requireLongDia:!1,peak:75},"rapid-acting":{requireLongDia:!0,peak:75,tdMin:300},"ultra-rapid":{requireLongDia:!0,peak:55,tdMin:300}},g="bilinear";void 0!==o.curve&&(g=o.curve.toLowerCase()),g in f||(console.error('Unsupported curve function: "'+g+'". Supported curves: "bilinear", "rapid-acting" (Novolog, Novorapid, Humalog, Apidra) and "ultra-rapid" (Fiasp). Defaulting to "rapid-acting".'),g="rapid-acting");var v=f[g];return v.requireLongDia&&s<5&&(s=5),a=v.peak,n.forEach((function(e){if(e.date<=r){var n=r-60*s*60*1e3;if(e.date>n){var f=i(e,t,g,s,a,o);f&&f.iobContrib&&(u+=f.iobContrib),f&&f.activityContrib&&(c+=f.activityContrib),e.insulin&&f&&f.iobContrib&&(e.insulin<.1?(l+=f.iobContrib,p+=e.insulin):(d+=f.iobContrib,m+=e.insulin))}}})),{iob:Math.round(1e3*u)/1e3,activity:Math.round(1e4*c)/1e4,basaliob:Math.round(1e3*l)/1e3,bolusiob:Math.round(1e3*d)/1e3,netbasalinsulin:Math.round(1e3*p)/1e3,bolusinsulin:Math.round(1e3*m)/1e3,time:t}}},257:(e,t)=>{e.exports=function(e){var t=e.start.getTime(),a=e.end.getTime(),r=e.treatments,i=(e.profile,0);return r?(r.forEach((function(e){e.insulin&&e.date>t&&e.date<=a&&(i+=e.insulin)})),{insulin:Math.round(1e3*i)/1e3}):(console.error("No treatments to process."),{})}},260:(e,t)=>{"use strict";function a(e,t,a){for(var r=0;r<e.length;r++){var i=e[r];if(i.timestamp===t&&void 0!==i[a])return!0;if(void 0!==i[a]){var n=new Date(i.timestamp),o=new Date(t),s=new Date(o.getTime()-2e3),u=new Date(o.getTime()+2e3);if(n>s&&n<u)return!0}}return!1}e.exports=function(e){for(var t=e.history,r=e.carbs,i=(e.profile,[]),n=[],o=0;o<r.length;o++){var s=r[o];if(s.carbs&&s.created_at){var u={};u.timestamp=s.created_at,u.carbs=s.carbs,u.nsCarbs=s.carbs,a(i,s.created_at,"carbs")?1:i.push(u)}}for(o=0;o<t.length;o++)"Bolus"===(s=t[o])._type&&s.timestamp?((u={}).timestamp=s.timestamp,u.bolus=s.amount,a(i,s.timestamp,"bolus")?1:i.push(u)):"BolusWizard"===s._type&&s.timestamp?n.push(s):"Meal Bolus"!==s._type&&"Correction Bolus"!==s._type&&"Snack Bolus"!==s._type&&"Bolus Wizard"!==s._type&&"Carb Correction"!==s._type||!s.created_at?"xdrip"===s.enteredBy?((u={}).timestamp=s.created_at,u.carbs=s.carbs,u.nsCarbs=s.carbs,u.bolus=s.insulin,a(i,s.timestamp,"carbs")?1:i.push(u)):s.carbs>0?((u={}).carbs=s.carbs,u.nsCarbs=s.carbs,u.timestamp=s.created_at,u.bolus=s.insulin,a(i,s.timestamp,"carbs")?1:i.push(u)):"JournalEntryMealMarker"===s._type&&s.carb_input>0&&s.timestamp&&((u={}).timestamp=s.timestamp,u.carbs=s.carb_input,u.journalCarbs=s.carb_input,a(i,s.timestamp,"carbs")?1:i.push(u)):((u={}).timestamp=s.created_at,u.carbs=s.carbs,u.nsCarbs=s.carbs,a(i,s.created_at,"carbs")?1:i.push(u));for(o=0;o<n.length;o++)s=n[o],(u={}).timestamp=s.timestamp,u.carbs=s.carb_input,u.bwCarbs=s.carb_input,a(i,s.timestamp,"carbs")?1:a(i,s.timestamp,"bolus")?i.push(u):(console.error("Skipping bolus wizard entry",o,"in the pump history with",s.carb_input,"g carbs and no insulin."),0===s.carb_input&&console.error("This is caused by a BolusWizard without carbs. If you specified insulin, it will be noted as a seperate Bolus"),s.timestamp&&console.error("Timestamp of bolus wizard:",s.timestamp));return i}},466:(e,t)=>{e.exports=function(e){if(void 0===e)return new Date;if(null===e)throw new TypeError("Null date input");if(e instanceof Date)return new Date(e.getTime());if("number"==typeof e){const t=new Date(e);if(!t)throw new TypeError(`Invalid date input: ${e}`);return t}if("string"==typeof e){const t=Date.parse(e);if(isNaN(t))throw new TypeError(`Invalid date input (string): ${e}`);return new Date(t)}throw new TypeError("Unsupported date input: "+typeof e)}},497:(e,t)=>{"use strict";function a(e,t,a){var r=t;void 0===t&&(r=new Date);var i=60*r.getHours()+r.getMinutes();if(a&&i>=a.offset&&i<a.endOffset)return[a.sensitivity,a];var n=(e=e.sensitivities.slice().sort(((e,t)=>e.offset-t.offset)))[e.length-1];if(0!==e[0].offset)return[-1,a];for(var o=1440,s=0;s<e.length-1;s++){var u=e[s],l=e[s+1];if(i>=u.offset&&i<l.offset){o=l.offset,n=e[s];break}}return(a=n).endOffset=o,[n.sensitivity,a]}a.isfLookup=a,e.exports=a},635:(e,t,a)=>{"use strict";var r=a(83),i=a(466);function n(e,t){var a=[e];if("recurring"===t.type){var r=60*e.started_at.getHours()+e.started_at.getMinutes(),n=r+e.duration;if(e.duration>30||r<t.minutes&&n>t.minutes||n>1440&&t.minutes<n-1440){var o=structuredClone(e),s=structuredClone(e),u=0;if(e.duration>30)u=30;else{var l=t.minutes;n>1440&&(l=1440),u=l-r}var d=new Date(i(e.started_at).getTime()+60*u*1e3);o.duration=u,s.duration=e.duration-u,s.timestamp=d.toISOString(),s.started_at=new Date(s.timestamp),s.date=s.started_at.getTime(),a=[o,s]}}return a}function o(e,t){for(var a=[e],r=!0;r;){var i=[];for(const e of a){r=!1;for(const a of t){const t=n(e,a);if(t.length>1){i.push(...t),r=!0;break}}r||i.push(e)}a=i}return a}e.exports=function(e,t){var a,n,s=e.history,u=(e.history24,e.profile),l=e.autosens,d=[],p=[],m=[],c=[],f=!1,g=!1,v=i(e.clock);if(e.history24)s=[].concat(e.history).concat(e.history24);for(var h=v,b=0;b<s.length;b++){var _={};"PumpSuspend"===(y=s[b])._type?(_.timestamp=y.timestamp,_.started_at=i(y.timestamp),_.date=_.started_at.getTime(),m.push(_)):"PumpResume"===y._type&&(_.timestamp=y.timestamp,_.started_at=i(y.timestamp),_.date=_.started_at.getTime(),c.push(_))}m.sort(((e,t)=>e.date-t.date)),c.sort(((e,t)=>e.date-t.date)),c.length>0&&(a=c[0].timestamp,(0===m.length||c[0].date<m[0].date)&&(f=!0));var T=0;for(b=0;b<m.length;b++){for(;T<c.length&&!(c[T].date>m[b].date);T++);if(T>=c.length&&!g){g=1,n=m[b].timestamp;break}m[b].duration=(c[T].date-m[b].date)/60/1e3}for(f||g||c.length===m.length?f&&!g&&c.length-1!==m.length?console.error("Mismatched number of resumes("+c.length+") and suspends("+m.length+") assuming suspended prior to history block!"):!f&&g&&c.length!==m.length-1?console.error("Mismatched number of resumes("+c.length+") and suspends("+m.length+") assuming suspended past end of history block!"):f&&g&&c.length!==m.length&&console.error("Mismatched number of resumes("+c.length+") and suspends("+m.length+") assuming suspended prior to and past end of history block!"):console.error("Mismatched number of resumes("+c.length+") and suspends("+m.length+")!"),b<m.length-1&&m.splice(b+1,m.length-b-1),b=0;b<s.length;b++){var y;if((y=s[b]).bolus&&"Bolus"===y.bolus._type)y=(_=y).bolus;y.created_at&&(y.timestamp=y.created_at);var D=i(y.timestamp);if(!(D>h))if(h=D,"Bolus"===y._type)(_={}).timestamp=y.timestamp,_.started_at=i(y.timestamp),_.started_at>v?process.stderr.write(" "+y.amount+"U @ "+_.started_at):(_.date=_.started_at.getTime(),_.insulin=y.amount,p.push(_));else if("Meal Bolus"===y.eventType||"Correction Bolus"===y.eventType||"Snack Bolus"===y.eventType||"Bolus Wizard"===y.eventType){(_={}).timestamp=y.created_at,_.started_at=i(_.timestamp),_.date=_.started_at.getTime(),_.insulin=y.insulin,p.push(_)}else if("xdrip"===y.enteredBy){(_={}).timestamp=y.timestamp,_.started_at=i(_.timestamp),_.date=_.started_at.getTime(),_.insulin=y.insulin,p.push(_)}else if("HAPP_App"===y.enteredBy&&y.insulin){(_={}).timestamp=y.created_at,_.started_at=i(_.timestamp),_.date=_.started_at.getTime(),_.insulin=y.insulin,p.push(_)}else if("Temp Basal"!==y.eventType||"HAPP_App"!==y.enteredBy&&"openaps://AndroidAPS"!==y.enteredBy){if("Temp Basal"===y.eventType){(_={}).rate=y.rate,_.duration=y.duration,void 0!==y.amount&&(_.rate=y.amount/y.duration*60),_.timestamp=y.timestamp,_.started_at=i(_.timestamp),_.date=_.started_at.getTime(),d.push(_)}else if("TempBasal"===y._type){if("percent"===y.temp)continue;var M,w=y.rate,C=y.timestamp;if(b>0&&s[b-1].timestamp===C&&"TempBasalDuration"===s[b-1]._type)M=s[b-1]["duration (min)"];else{for(var k=0;k<s.length;k++)if(s[k].timestamp===C&&"TempBasalDuration"===s[k]._type){M=s[k]["duration (min)"];break}void 0===M&&console.error("No duration found for "+w+" U/hr basal "+C,s[b-1],y,s[b+1])}(_={}).rate=w,_.timestamp=y.timestamp,_.started_at=i(_.timestamp),_.date=_.started_at.getTime(),_.duration=M,d.push(_)}}else{(_={}).rate=y.absolute,_.duration=y.duration,_.timestamp=y.created_at,_.started_at=i(_.timestamp),_.date=_.started_at.getTime(),d.push(_)}}for((_={rate:0}).started_at=new Date(v.getTime()+6e4),_.date=_.started_at.getTime(),_.duration=t||0,d.push(_),d.sort(((e,t)=>e.date-t.date)),b=0;b+1<d.length;b++)d[b].date+60*d[b].duration*1e3>d[b+1].date&&(d[b].duration=(d[b+1].date-d[b].date)/60/1e3,null===d[b+1].duration&&d.splice(b+1,1));var S=[];u.basalprofile.forEach((e=>{const t={type:"recurring",minutes:e.minutes};S.push(t)}));var B=[];d.forEach((e=>{B=B.concat(o(e,S))})),d.sort(((e,t)=>e.date-t.date));var x,P=!1;if(void 0!==u.suspend_zeros_iob&&(P=u.suspend_zeros_iob),P){var I=[];B.forEach((e=>{var t=function(e,t,a,r,n,o){var s=[],u=new Date(a).getTime(),l=new Date(n).getTime();if(r&&e.date<u&&(e.date+60*e.duration*1e3<u?e.duration=0:(e.duration=(e.date+60*e.duration*1e3-u)/60/1e3,e.started_at=i(a),e.date=u)),o&&l&&e.date+60*e.duration*1e3>l&&(e.date>l?e.duration=0:e.duration=(l-e.date)/60/1e3),s.push(e),0===e.duration)return s;for(var d=0;d<t.length;d++)for(var p=t[d],m=0;m<s.length;m++)if(s[m].date<=p.date&&s[m].date+60*s[m].duration*1e3>p.date){if(s[m].date+60*s[m].duration*1e3>p.date+60*p.duration*1e3){var c=structuredClone(s[m]),f=new Date(i(p.started_at).getTime()+60*p.duration*1e3);c.timestamp=f.toISOString(),c.started_at=i(c.timestamp),c.date=p.date+60*p.duration*1e3,c.duration=(s[m].date+60*s[m].duration*1e3-(p.date+60*p.duration*1e3))/60/1e3,s.push(c)}s[m].duration=(p.date-s[m].date)/60/1e3}else if(p.date<=s[m].date&&p.date+60*p.duration*1e3>s[m].date){s[m].duration=(s[m].date+60*s[m].duration*1e3-(p.date+60*p.duration*1e3))/60/1e3;var g=new Date(i(p.started_at).getTime()+60*p.duration*1e3);s[m].timestamp=g.toISOString(),s[m].started_at=i(s[m].timestamp),s[m].date=p.date+60*p.duration*1e3}return s}(e,m,a,f,n,g);I.push(...t)}));var R=[];m.forEach((e=>{void 0!==e.duration&&R.push({_type:"SuspendBasal",rate:0,duration:e.duration,date:e.date,started_at:e.started_at})}));var A=v.getTime()-288e5,E=new Date(a).getTime();if(f&&A<E){var F=[{_type:"SuspendBasal",rate:0,duration:(E-A)/60/1e3,date:O=(z=new Date(A)).getTime(),started_at:L=i(z)}];R=R.concat(F)}if(g){var z,O=(z=new Date(n)).getTime(),L=i(z);F=[{_type:"SuspendBasal",rate:0,duration:(v-O)/60/1e3,date:O,timestamp:n,started_at:L}];R=R.concat(F)}R.forEach((e=>{I=I.concat(o(e,S))}))}else I=B;for(I.sort(((e,t)=>e.date-t.date)),b=0;b<I.length;b++){var N=I[b];if(N.duration>0){var G,H,U=u.current_basal;u.basalprofile&&u.basalprofile.length>0&&(U=r.basalLookup(u.basalprofile,new Date(N.timestamp))),void 0!==u.min_bg&&void 0!==u.max_bg&&(G=(u.min_bg+u.max_bg)/2);var W=u;if(W.half_basal_exercise_target)var J=W.half_basal_exercise_target;else J=160;if(W.exercise_mode&&W.temptargetSet&&G>=105){var q=J-100;H=q/(q+G-100)}else void 0!==l&&(H=l.ratio);H&&(U*=H);var j=N.rate-U;x=j<0?-.05:.05;var Z=Math.round(j*N.duration*10/6)/100,$=Math.round(Z/x),K=N.duration/$;for(T=0;T<$;T++){var Q={};Q.insulin=x,Q.date=N.date+T*K*60*1e3,Q.created_at=new Date(Q.date),p.push(Q)}}}var V=[].concat(p).concat(d);return V.sort(((e,t)=>e.date-t.date)),V}},663:(e,t)=>{"use strict";e.exports=function(e,t,a,r,i,n){if(e.insulin){void 0===t&&(t=new Date);var o=new Date(e.date),s=Math.round((t-o)/1e3/60);return"bilinear"===a?function(e,t,a){var r=75,i=180,n=3/a,o=n*t,s=0,u=0,l=2/(60*a),d=l/r,p=l/(i-r)*-1;if(o<r){s=e.insulin*(d*o);var m=o/5+1;u=e.insulin*(-.001852*m*m+.001852*m+1)}else if(o<i){var c=o-r;s=e.insulin*(l+p*c);var f=(o-r)/5;u=e.insulin*(.001323*f*f+-.054233*f+.55556)}return{activityContrib:s,iobContrib:u}}(e,s,r):function(e,t,a,r,i){"rapid-acting"===i.curve?!0===i.useCustomPeakTime&&void 0!==i.insulinPeakTime?i.insulinPeakTime>120?(console.error("Setting maximum Insulin Peak Time of 120m for",i.curve,"insulin"),r=120):i.insulinPeakTime<50?(console.error("Setting minimum Insulin Peak Time of 50m for",i.curve,"insulin"),r=50):r=i.insulinPeakTime:r=75:"ultra-rapid"===i.curve?!0===i.useCustomPeakTime&&void 0!==i.insulinPeakTime?i.insulinPeakTime>100?(console.error("Setting maximum Insulin Peak Time of 100m for",i.curve,"insulin"),r=100):i.insulinPeakTime<35?(console.error("Setting minimum Insulin Peak Time of 35m for",i.curve,"insulin"),r=35):r=i.insulinPeakTime:r=55:console.error("Curve of",i.curve,"is not supported.");var n=60*a,o=0,s=0;if(t<n){var u=r*(1-r/n)/(1-2*r/n),l=2*u/n,d=1/(1-l+(1+l)*Math.exp(-n/u));o=e.insulin*(d/Math.pow(u,2))*t*(1-t/n)*Math.exp(-t/u),s=e.insulin*(1-d*(1-l)*((Math.pow(t,2)/(u*n*(1-l))-t/u-1)*Math.exp(-t/u)+1))}return{activityContrib:o,iobContrib:s}}(e,s,r,i,n)}return{}}},785:(e,t,a)=>{"use strict";var r=a(466),i=a(83),n=a(191),o=a(497),s=a(635),u=a(257);e.exports=function(e){var t=e.treatments;t.sort((function(e,t){var a=r(e.timestamp);return r(t.timestamp).getTime()-a.getTime()}));var a=e.profile,l=[];if(void 0!==e.glucose&&(l=e.glucose.map((function(e){return e.glucose=e.glucose||e.sgv,e.date||(e.displayTime?e.date=new Date(e.displayTime.replace("T"," ")).getTime():e.dateString&&(e.date=new Date(e.dateString).getTime())),e.dateString||(e.dateString=r(e.date).toISOString()),e})).filter((function(e){return e.date&&e.glucose&&e.glucose>=39})).sort((function(e,t){return t.date-e.date}))),!t)return{};var d={profile:a,history:e.pumpHistory},p=[],m=[],c=[],f=[],g=[],v=[];v[0]=JSON.parse(JSON.stringify(l[0]));for(var h=0,b=0,_=1;_<l.length;++_){var T=l[_].date,y=(T-l[b].date)/6e4;if(Math.abs(y)>=2)b=_,v[++h]=JSON.parse(JSON.stringify(l[_]));else{var D=l.slice(b,_+1).reduce((function(e,t){return e+t.glucose}),0);v[h].glucose=D/(_-b+1)}}for(_=t.length-1;_>0;--_){var M=t[_];if(M){var w=r(M.timestamp),C=w.getTime(),k=v[v.length-1];if(k){var S=new Date(k.date);C<(T=S.getTime())&&t.splice(_,1)}}}var B=!1,x=0,P=0,I=0,R=0,A=0,E="",F=d.history,z=null;for(_=v.length-5;_>0;--_){k=v[_],T=(S=new Date(k.date)).getTime();var O,L,N,G,H=0;if((M=t[t.length-1])&&(C=(w=r(M.timestamp)).getTime())<T&&(M.carbs>=1&&(I+=parseFloat(M.carbs),R+=parseFloat(M.carbs),H=M.carbs),t.pop()),void 0!==v[_].glucose&&void 0!==v[_+4].glucose){if((O=v[_].glucose)<40||v[_+4].glucose<40)continue;L=O-v[_+1].glucose,N=(O-v[_+4].glucose)/4}else console.error("Could not find glucose data");N=N.toFixed(2),k.avgDelta=N,[G,z]=o.isfLookup(d.profile.isfProfile,S,z),d.clock=S.toISOString();for(var U=[],W=0;W<F.length;W++){var J=new Date(F[W].created_at);S-J<216e5&&S-J>0&&U.push(F[W])}d.history=U;var q=i.basalLookup(e.pumpbasalprofile,S),j=new Date(T-36e5),Z=new Date(T-72e5),$=new Date(T-108e5),K=[q,i.basalLookup(e.pumpbasalprofile,j),i.basalLookup(e.pumpbasalprofile,Z),i.basalLookup(e.pumpbasalprofile,$)].reduce((function(e,t){return e+t}));d.profile.currentBasal=Math.round(K/4*1e3)/1e3;var Q=i.basalLookup(e.basalprofile,S),V=Math.round(Q*G/60*5*100)/100,X=n(d)[0],Y=Math.round(-X.activity*G*5*100)/100;k.BGI=Y;var ee=N-Y,te=L-Y;if(O<80&&ee>0&&(ee=0),ee=ee.toFixed(2),te=te.toFixed(2),k.deviation=ee,I>0){var ae=a,re=Math.max(ee,ae.min_5m_carbimpact)*ae.carb_ratio/G;I=Math.max(0,I-re)}if(I>0||B){if(A+=H,!B){var ie=X.iob,ne=k.glucose,oe=new Date(k.date);console.error("CRInitialIOB:",ie,"CRInitialBG:",ne,"CRInitialCarbTime:",oe)}if(I>0&&_>1)B=!0;else if(X.iob>Q/2&&_>1)B=!0;else{var se=X.iob,ue=k.glucose,le=new Date(k.date);console.error("CREndIOB:",se,"CREndBG:",ue,"CREndTime:",le);var de={CRInitialIOB:ie,CRInitialBG:ne,CRInitialCarbTime:oe,CREndIOB:se,CREndBG:ue,CREndTime:le,CRCarbs:A},pe=Math.round((le-oe)/1e3/60);pe<60||1===_&&I>0?console.error("Ignoring",pe,"m CR period."):g.push(de),A=0,B=!1}}I>0||x||R>0?((x=X.iob<Q/2?0:ee>0?1:0)||I||(R=0),"csf"!==E&&(k.mealAbsorption="start",console.error(k.mealAbsorption,"carb absorption")),E="csf",k.mealCarbs=R,p.push(k)):("csf"===E&&(p[p.length-1].mealAbsorption="end",console.error(p[p.length-1].mealAbsorption,"carb absorption")),X.iob>2*Q||ee>6||P?(P=ee>0?1:0,"uam"!==E&&(k.uamAbsorption="start",console.error(k.uamAbsorption,"uannnounced meal absorption")),E="uam",f.push(k)):("uam"===E&&console.error("end unannounced meal absorption"),V>-4*Y||N>0&&N>-2*Y?(E="basal",c.push(k)):(E="ISF",m.push(k)))),T=S.toString().split(" ")[4],console.error(x.toString(),"mealCOB:",I.toFixed(1),"mealCarbs:",R,"BGI:",Y.toFixed(1),"IOB:",X.iob.toFixed(1),"at",T,"dev:",te,"avgDev:",ee,"avgDelta:",N,E,O,H)}d={profile:a,history:e.pumpHistory},t=s(d),g.forEach((function(a){var r={treatments:t,profile:e.profile,start:a.CRInitialCarbTime,end:a.CREndTime},i=u(r);a.CRInsulin=i.insulin}));var me=p.length,ce=m.length,fe=f.length,ge=c.length;if(e.categorize_uam_as_basal)console.error("--categorize-uam-as-basal=true set: categorizing all UAM data as basal."),c=c.concat(f);else if(me>12)console.error("Found at least 1h of carb absorption: assuming all meals were announced, and categorizing UAM data as basal."),c=c.concat(f);else{if(2*ge<fe){console.error("Warning: too many deviations categorized as UnAnnounced Meals"),console.error("Adding",fe,"UAM deviations to",ge,"basal ones"),(c=c.concat(f)).sort((function(e,t){return e.deviation-t.deviation}));var ve=c.slice(0,c.length/2);c=ve,console.error("and selecting the lowest 50%, leaving",c.length,"basal+UAM ones")}if(2*ce<fe&&ce<10){console.error("Adding",fe,"UAM deviations to",ce,"ISF ones"),(m=m.concat(f)).sort((function(e,t){return e.deviation-t.deviation}));var he=m.slice(0,m.length/2);m=he,console.error("and selecting the lowest 50%, leaving",m.length,"ISF+UAM ones")}}return 4*(ge=c.length)+(ce=m.length)<me&&ce<10&&(console.error("Warning: too many deviations categorized as meals"),console.error("Adding",me,"CSF deviations to",ce,"ISF ones"),m=m.concat(p),p=[]),{CRData:g,CSFGlucoseData:p,ISFGlucoseData:m,basalGlucoseData:c}}}},t={};var a=function a(r){var i=t[r];if(void 0!==i)return i.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,a),n.exports}(10);freeaps_autotunePrep=a})();